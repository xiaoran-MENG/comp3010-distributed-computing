<!DOCTYPE html>
<html>
<head>
    <title>3010-eeter</title>
    <style>
        * {
            font-size: 16px;
            font-family: 'Ubuntu Mono';
        }

        .banner {
            font-size: 48px;
            color: rgb(135, 11, 218)
        }

        #posts, #signin {
            cursor: pointer;
        }
    </style>
</head>
<body>
    <h1 class='banner'>3010-eeter</h1>
    <div>
        <input id="register-username" type="text" placeholder="username" />
        <input id="register-password" type="password" placeholder="password" />
        <button id="register" type="button" onclick="onRegister()">Register</button>
    </div>
    <br>
    <div>
        <input id="username" type="text" placeholder="username" />
        <input id="password" type="password" placeholder="password" />
        <button id="signin" type="button" onclick="onSignin()">Sign In</button>
    </div>
    <br>
    <button id="posts" type="button" onclick="onView()">See Posts</button>
    <input id='post' type='text' placeholder='Write your post'>
    <button id="upload" type="button" onclick="onAdd()">Add</button>
    <ul id="dashboard"></ul>
    <button type="button" onclick="onDisplay()">See Pictures</button>
    <ul id="pictures" style="visibility:hidden;">
        <img src="http://localhost:8080/images/binary" height="30%" width="30%" alt="Shit">
        <img src="http://localhost:8080/images/code" height="30%" width="30%" alt="Shit">
        <img src="http://localhost:8080/images/f" height="30%" width="30%" alt="Shit">
    </ul>
    <script>
        if (user()) {
            readyForSignout()
            renderPosts()
        }

        function onDisplay() {
            runIfSignedIn(() => {
                document.getElementById('pictures').style.visibility = 'visible'
            })
        }

        function onAdd() {
            runIfSignedIn(() => {
                const input = atId('post')
                if (!input?.length) return
                const req = new XMLHttpRequest()
                req.onload = function() {
                    clearInputs()
                    alert('Post saved')
                    renderPosts()
                }
                req.open('POST', 'http://localhost:8080/tweets')
                req.setRequestHeader('Content-Type', 'application/json')
                req.send(JSON.stringify({
                    'id': 100,
                    'content': input,
                    'author': user()
                }))
            })
        }

        function readyForSignout() {
            const btn = document.getElementById('signin')
            btn.innerText = 'Sign Out'
            btn.addEventListener('click', onSignout)
        }

        function clearInputs() {
            clearAtId('register-username')
            clearAtId('register-password')
            clearAtId('username')
            clearAtId('password')
            clearAtId('post')
        }          

        function onSignout() {
            const req = new XMLHttpRequest()
            req.onload = function() {
                let cookies = document.cookie.split(';')
                for (let i = 0; i < cookies.length; i++) {
                    document.cookie = cookies[i] + "=; expires="+ new Date(0).toUTCString();
                }

                const btn = document.getElementById('signin')
                btn.innerText = 'Sign in'
                btn.addEventListener('click', onSignin)
                document.getElementById('dashboard').innerHTML = ''
            }
            req.open('POST', 'http://localhost:8080/logout')
            req.setRequestHeader('Content-Type', 'application/json')
            req.send(JSON.stringify({
                'user': user()
            }))
        }

        function user() {
            for (let c of document.cookie.split(';'))
                if (c.trim().startsWith('user=')) return c.split('=')[1]
            return null
        }

        function onView() {
            runIfSignedIn(() => renderPosts())
        }

        function clearDashboard() {
            const dashboard = document.getElementById('dashboard')
            while (dashboard.firstChild) {
                dashboard.removeChild(dashboard.firstChild);
            }
        }

        function del(post) {
            const btn = document.createElement('button')
            btn.innerText = 'X'
            if (post['author'] === user())
                btn.style.color =  'red'
            btn.addEventListener('click', function() {
                runForAuthor(post['author'], () => {
                    const req = new XMLHttpRequest()
                    req.open('DELETE', `http://localhost:8080/tweets/${post['id']}`)
                    req.setRequestHeader('Content-Type', 'application/json')
                    req.onload = function() {
                        alert('Post deleted')
                        renderPosts()
                    }
                    req.send()
                })
            })
            return btn
        }

        function renderPosts() {
            const req = new XMLHttpRequest()
            req.onload = function() {
                alert('Render post')
                clearDashboard()
                const posts = JSON.parse(req.responseText)
                posts.forEach(p => {
                    const li = document.createElement('li')
                    li.innerText = p['content'] + ' '
                    li.appendChild(del(p))
                    document.getElementById('dashboard').appendChild(li)
                })
            }
            req.open('GET', 'http://localhost:8080/tweets')
            req.setRequestHeader("Accept","application/json")
            req.withCredentials = true
            req.send()
        }

        function onRegister() {
            onAuth('register', {
                username: atId('register-username'),
                password: atId('register-password')
            })
        }

        function onSignin() {
            onAuth('login', {
                username: atId('username'),
                password: atId('password')
            })
        }

        function onAuth(path, o) {
            console.log(o)
            const req = new XMLHttpRequest()
            req.addEventListener('load', function() {
                clearInputs()
                if (req.status == 200) {
                    readyForSignout()
                }
            })
            req.open('POST', 'http://localhost:8080/' + path)
            req.setRequestHeader('Content-Type', 'application/json')
            req.send(JSON.stringify(o))
        }

        function atId(id) {
            return document.getElementById(id).value
        }

        function clearAtId(id) {
            document.getElementById(id).value = ''
        }

        function runIfSignedIn(f) {
            if (user()) f()
            else alert('Please register or sign in')
        }

        function runForAuthor(author, f) {
            if (author === user()) f()
            else alert('Only author can perform this action')
        }
    </script>
</body>
</html>