<!DOCTYPE html>
<html>
<head>
    <title>3010-eeter</title>
</head>
<body>
    <h1>Welcome to 3010-eeter</h1>
    <div>
        <input id="username" type="text" placeholder="username" />
        <input id="password" type="password" placeholder="password" />
    </div>
    <button id="signin" type="button" onclick="onSignin()">Sign In</button>
    <h2>Tweets</h2>
    <ul id="dashboard"></ul>
    <script>
        function onSignin () {
            let { username } =  credentials();
            const req = new XMLHttpRequest()
            req.addEventListener('load', function() {
                alert('Signed in')
                document.getElementById('signin').innerText = 'Sign Out'
                document.getElementById('signin').addEventListener('click', onSignout)

                const sub = new XMLHttpRequest()
                sub.addEventListener('load', function() {
                    JSON.parse(sub.responseText).forEach(o => {
                        const li = document.createElement('li')
                        const btn = document.createElement('button')

                        btn.innerText = 'X'
                        btn.addEventListener('click', function() {
                            alert('Deleting post')
                            const xhr = new XMLHttpRequest()
                            xhr.addEventListener('load', function() {
                                alert('Deleted')
                            })
                            xhr.open('DELETE', `http://localhost:8080/tweets/${o['id']}`)
                            xhr.setRequestHeader('Content-Type', 'application/json')  
                            xhr.send()           
                        })

                        if (o['author'] === username) {
                            li.innerText = o['content']
                            li.appendChild(btn)
                            document.getElementById('dashboard').appendChild(li)
                        }
                    })
                })
                sub.open('GET', 'http://localhost:8080/tweets')
                sub.setRequestHeader("Accept","application/json")
                sub.withCredentials = true
                sub.send()
            })
            req.open('POST', 'http://localhost:8080/login')
            req.setRequestHeader('Content-Type', 'application/json')
            req.send(JSON.stringify(credentials()))
        
            function credentials() {
                return {
                    username: document.getElementById("username").value,
                    password: document.getElementById("password").value
                }
            }

            function onSignout() {
                alert('Signing out')
            }
        }
    </script>
</body>
</html>