<!DOCTYPE html>
<html>
<head>
    <title>3010-eeter</title>
    <style>
        * {
            font-size: 16px;
            font-family: 'Ubuntu Mono';
        }

        .banner {
            font-size: 48px;
            color: rgb(11, 94, 218)
        }

        #posts, #signin {
            cursor: pointer;
        }
    </style>
</head>
<body>
    <h1 class='banner'>3010-eeter</h1>
    <div>
        <input id="username" type="text" placeholder="username" />
        <input id="password" type="password" placeholder="password" />
        <button id="signin" type="button" onclick="onSignin()">Sign In</button>
    </div>
    <br>
    <button id="posts" type="button" onclick="onView()">See Posts</button>
    <input id='post' type='text' placeholder='Write your post'>
    <button id="upload" type="button" onclick="onSave()">Add</button>
    <ul id="dashboard"></ul>
    <button type="button" onclick="onDisplay()">See Pictures</button>
    <ul id="pictures" style="visibility:hidden;">
        <img src="http://localhost:8080/images" height="30%" width="30%" alt="Shit">
    </ul>
    <script>
        if (user()) readyForSignout()

        function onDisplay() {
            if (user()){
                const pics = document.getElementById('pictures')
                pics.style.visibility = 'visible';
            }
        }

        function onSave() {
            const content = document.getElementById('post').value
            if (!content?.length) return
            const post = {
                'id': 100,
                'content': content,
                'author': user()
            }
            const req = new XMLHttpRequest()
            req.addEventListener('load', function() {
                clearInputs()
                document.getElementById('posts').innerText = 'Refresh'
                renderPosts()
            })
            req.open('POST', 'http://localhost:8080/tweets')
            req.setRequestHeader('Content-Type', 'application/json')
            req.send(JSON.stringify(post))
        }

        function readyForSignout() {
            const btn = document.getElementById('signin')
            btn.innerText = 'Sign Out'
            btn.addEventListener('click', onSignout)
        }

        function clearInputs() {
            document.getElementById('username').value = ''
            document.getElementById('password').value = ''
            document.getElementById('post').value = ''
        }          

        function onSignout() {
            const req = new XMLHttpRequest()
            req.addEventListener('load', function() {
                let cookies = document.cookie.split(';')
                for (let i = 0; i < cookies.length; i++) {
                    document.cookie = cookies[i] + "=; expires="+ new Date(0).toUTCString();
                }

                const btn = document.getElementById('signin')
                btn.innerText = 'Sign in'
                btn.addEventListener('click', onSignin)

                document.getElementById('dashboard').innerHTML = ''
            })
            req.open('POST', 'http://localhost:8080/logout')
            req.setRequestHeader('Content-Type', 'application/json')
            req.send(JSON.stringify({
                'user': user()
            }))
        }

        function user() {
            for (let c of document.cookie.split(';'))
                if (c.trim().startsWith('user=')) return c.split('=')[1]
            return null
        }

        function onView() {
            if (user()) {
                renderPosts()
            }
        }

        function clearDashboard() {
            const dashboard = document.getElementById('dashboard')
            while (dashboard.firstChild) {
                dashboard.removeChild(dashboard.firstChild);
            }
        }

        function deleteBtn(post) {
            const btn = document.createElement('button')
            btn.innerText = 'X'
            btn.addEventListener('click', function() {
                const req = new XMLHttpRequest()
                req.addEventListener('load', function() {
                    document.getElementById('posts').innerText = 'Refresh'
                })
                req.open('DELETE', `http://localhost:8080/tweets/${post['id']}`)
                req.setRequestHeader('Content-Type', 'application/json')  
                req.send()           
            })
            return btn
        }

        function renderPosts() {
            const req = new XMLHttpRequest()
            req.addEventListener('load', function() {
                console.log('Render post')
                clearDashboard()
                const posts = JSON.parse(req.responseText)
                posts.forEach(p => {
                    const li = document.createElement('li')
                    li.innerText = p['content'] + ' '
                    if (p['author'] === user())
                        li.appendChild(deleteBtn(p))
                    document.getElementById('dashboard').appendChild(li)
                })
            })
            req.open('GET', 'http://localhost:8080/tweets')
            req.setRequestHeader("Accept","application/json")
            req.withCredentials = true
            req.send()
        }

        function onSignin() {
            const req = new XMLHttpRequest()
            req.addEventListener('load', function() {
                clearInputs()
                if (req.status == 200) {
                    readyForSignout()
                }
            })
            req.open('POST', 'http://localhost:8080/login')
            req.setRequestHeader('Content-Type', 'application/json')
            req.send(JSON.stringify({
                username: document.getElementById('username').value,
                password: document.getElementById('password').value
            }))
        }
    
    </script>
</body>
</html>